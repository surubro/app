<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Back4App Chat Mobile-Friendly</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/parse/dist/parse.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #fff;
}

.box {
  width: 95%;
  max-width: 420px;
  background: rgba(0,0,0,0.4);
  border-radius: 12px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  height: 90vh;
}

input, button {
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  border-radius: 6px;
  border: none;
  outline: none;
  font-size: 16px;
}

button {
  background: #00c6ff;
  font-weight: bold;
  cursor: pointer;
}

.chat {
  display: none;
  flex-direction: column;
  flex: 1;
}

.messages {
  flex: 1;
  overflow-y: auto;
  margin: 10px 0;
  max-height: calc(100% - 200px);
}

.message {
  background: #00c6ff;
  color: #000;
  padding: 8px;
  margin-bottom: 8px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
}

.message a {
  display: block;
  font-size: 14px;
  color: #003366;
  text-decoration: underline;
  margin-top: 4px;
}

.danger {
  background: #ff4d4d;
  color: #fff;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 6px;
  margin-top: 4px;
}
</style>
</head>
<body>

<!-- LOGIN / REGISTER -->
<div class="box" id="authBox">
  <h3>Login / Register</h3>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="register()">Register</button>
</div>

<!-- CHAT -->
<div class="box chat" id="chatBox">
  <button class="danger" onclick="logout()">Logout</button>

  <div class="messages" id="messages"></div>

  <input id="textInput" placeholder="Message">
  <button onclick="sendText()">Send Message</button>

  <input type="file" id="fileInput">
  <button onclick="sendFile()">Send File</button>
</div>

<script>
Parse.initialize("DDn3pRW0GSEcX2ZnV4vD6ATRyVVlCelTCWjzGI29","Ar2XAAFl4N0kzo6uUcBwlp3FSFgjeAj5VpbyfT6R");
Parse.serverURL="https://parseapi.back4app.com/";

const Message = Parse.Object.extend("Message");
const authBox = document.getElementById("authBox");
const chatBox = document.getElementById("chatBox");
const messagesDiv = document.getElementById("messages");

function checkAuth() {
  if(Parse.User.current()){
    authBox.style.display="none";
    chatBox.style.display="flex";
    loadMessages();
  }else{
    authBox.style.display="block";
    chatBox.style.display="none";
  }
}

async function login(){
  const u=username.value.trim();
  const p=password.value.trim();
  if(!u || !p) return alert("Enter username and password");
  try{
    await Parse.User.logIn(u,p);
    checkAuth();
  }catch(e){ alert(e.message); }
}

async function register(){
  const u=username.value.trim();
  const p=password.value.trim();
  if(!u || !p) return alert("Enter username and password");
  const user=new Parse.User();
  user.set("username",u);
  user.set("password",p);
  try{ await user.signUp(); checkAuth(); }catch(e){ alert(e.message); }
}

async function logout(){
  await Parse.User.logOut();
  checkAuth();
}

async function loadMessages(){
  const q=new Parse.Query(Message);
  q.ascending("createdAt");
  q.limit(50);
  const res=await q.find();
  messagesDiv.innerHTML="";
  res.forEach(m=>{
    const div=document.createElement("div");
    div.className="message";

    const content=document.createElement("div");
    content.textContent=m.get("text")||"";

    const file=m.get("file");
    if(file){
      const a=document.createElement("a");
      a.href=file.url();
      a.target="_blank";
      a.textContent=`ðŸ“Ž ${file.name()}`;
      content.appendChild(a);
    }

    const del=document.createElement("button");
    del.textContent="X";
    del.className="danger";
    del.onclick=()=>deleteMsg(m.id);

    div.appendChild(content);
    div.appendChild(del);
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

async function sendText(){
  const text=textInput.value.trim();
  if(!text) return;
  const m=new Message();
  m.set("text",text);
  m.set("user",Parse.User.current());
  await m.save();
  textInput.value="";
  loadMessages();
}

async function sendFile(){
  const file=fileInput.files[0];
  if(!file) return alert("Select a file");
  const pf=new Parse.File(file.name,file);
  await pf.save();
  const m=new Message();
  m.set("file",pf);
  m.set("user",Parse.User.current());
  await m.save();
  fileInput.value="";
  loadMessages();
}

async function deleteMsg(id){
  if(!confirm("Delete this message?")) return;
  const q=new Parse.Query(Message);
  const m=await q.get(id);
  await m.destroy();
  loadMessages();
}

checkAuth();
</script>

</body>
</html>
