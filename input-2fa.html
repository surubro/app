<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Private TOTP Vault</title>
<style>
  body { font-family: -apple-system, sans-serif; background: #f4f7f9; display: flex; justify-content: center; padding: 20px; }
  .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 400px; text-align: center; }
  h2 { margin-top: 0; color: #333; }
  
  /* OTP Display */
  .otp-val { font-size: 48px; font-family: monospace; font-weight: bold; color: #1a73e8; margin: 10px 0; cursor: pointer; }
  .timer-text { font-size: 14px; color: #666; margin-bottom: 20px; }
  .active-label { font-size: 16px; font-weight: bold; color: #555; text-transform: uppercase; }

  /* Inputs */
  .input-box { margin: 20px 0; border-top: 1px solid #eee; padding-top: 20px; }
  input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  .btn-save { width: 100%; padding: 10px; background: #34a853; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
  
  /* Account List */
  .account-list { text-align: left; margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; }
  .acc-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #fafafa; }
  .acc-item:hover { background: #f9f9f9; cursor: pointer; }
  .del-btn { color: #ff4444; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 18px; }
  .toast { font-size: 12px; color: green; height: 15px; margin-bottom: 5px; }
</style>
</head>
<body>

<div class="card">
  <h2>TOTP Vault</h2>
  <div id="activeAccount" class="active-label">Select an account</div>
  <div class="otp-val" id="otpDisplay" onclick="copyToClipboard()">------</div>
  <div class="timer-text">Refresh in: <span id="timeLeft">30</span>s</div>
  <div id="toast" class="toast"></div>

  <div class="input-box">
    <input id="accName" placeholder="Account Name (e.g. Amazon)">
    <input id="accKey" placeholder="Base32 Secret Key">
    <button class="btn-save" onclick="saveAccount()">Add Account</button>
  </div>

  <div class="account-list" id="accountList">
    </div>
</div>

<script>
/* ====== CORE LOGIC (Using your working method) ====== */
function base32ToBytes(base32) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
  let bits = "";
  let bytes = [];
  base32 = base32.replace(/[\s=]/g, "").toUpperCase();
  for (let i = 0; i < base32.length; i++) {
    const val = chars.indexOf(base32.charAt(i));
    if (val === -1) continue;
    bits += val.toString(2).padStart(5, "0");
  }
  for (let i = 0; i + 8 <= bits.length; i += 8) {
    bytes.push(parseInt(bits.substring(i, i + 8), 2));
  }
  return new Uint8Array(bytes);
}

async function generateTOTP(secret) {
  try {
    const keyBytes = base32ToBytes(secret);
    if (keyBytes.length === 0) return "ERROR";
    const key = await crypto.subtle.importKey(
      "raw", keyBytes, { name: "HMAC", hash: "SHA-1" }, false, ["sign"]
    );
    const counter = Math.floor(Date.now() / 1000 / 30);
    const buffer = new ArrayBuffer(8);
    new DataView(buffer).setUint32(4, counter);
    const hmac = new Uint8Array(await crypto.subtle.sign("HMAC", key, buffer));
    const offset = hmac[hmac.length - 1] & 0xf;
    const code = ((hmac[offset] & 0x7f) << 24) | ((hmac[offset+1] & 0xff) << 16) | ((hmac[offset+2] & 0xff) << 8) | (hmac[offset+3] & 0xff);
    return (code % 1000000).toString().padStart(6, "0");
  } catch (e) { return "HTTPS REQ"; }
}

/* ====== STORAGE & UI ====== */
let accounts = JSON.parse(localStorage.getItem('my_otp_vault')) || [];
let activeIdx = -1;

function saveAccount() {
  const name = document.getElementById('accName').value.trim();
  const key = document.getElementById('accKey').value.trim();
  if (name && key) {
    accounts.push({ name, key });
    localStorage.setItem('my_otp_vault', JSON.stringify(accounts));
    document.getElementById('accName').value = "";
    document.getElementById('accKey').value = "";
    renderList();
  }
}

function deleteAccount(e, index) {
  e.stopPropagation();
  accounts.splice(index, 1);
  localStorage.setItem('my_otp_vault', JSON.stringify(accounts));
  if (activeIdx === index) activeIdx = -1;
  renderList();
}

async function selectAccount(index) {
  activeIdx = index;
  const acc = accounts[index];
  document.getElementById('activeAccount').textContent = acc.name;
  const code = await generateTOTP(acc.key);
  document.getElementById('otpDisplay').textContent = code;
}

function renderList() {
  const container = document.getElementById('accountList');
  container.innerHTML = "";
  accounts.forEach((acc, i) => {
    const div = document.createElement('div');
    div.className = "acc-item";
    div.onclick = () => selectAccount(i);
    div.innerHTML = `
      <span>${acc.name}</span>
      <button class="del-btn" onclick="deleteAccount(event, ${i})">&times;</button>
    `;
    container.appendChild(div);
  });
  if(activeIdx === -1) {
    document.getElementById('activeAccount').textContent = "Select an account";
    document.getElementById('otpDisplay').textContent = "------";
  }
}

function copyToClipboard() {
  const text = document.getElementById("otpDisplay").textContent;
  if (text.includes("-")) return;
  navigator.clipboard.writeText(text);
  const toast = document.getElementById("toast");
  toast.textContent = "Copied!";
  setTimeout(() => toast.textContent = "", 2000);
}

// Timer Loop
setInterval(async () => {
  const now = Math.floor(Date.now() / 1000);
  const remaining = 30 - (now % 30);
  document.getElementById("timeLeft").textContent = remaining;
  if (remaining === 30 && activeIdx !== -1) {
    selectAccount(activeIdx);
  }
}, 1000);

renderList();
</script>

</body>
</html>
